\documentclass{article}

\usepackage{amsmath}
\usepackage[margin=0.75in]{geometry}
\usepackage{graphicx}
\usepackage{hyperref}
\hypersetup{
	linkcolor=blue,
	colorlinks=true
}
\usepackage{blkarray}


\title{The theory and implementation of kCON}

\author{Xin Chen}
\date{\today}


\begin{document}
\maketitle


\section{Energy}

The energy of kCON is modeled under the many-body expression scheme:

\begin{eqnarray}
E^{total} = \sum_{a}^{C^N_1}{E^{(k=1)}_{a}} + \sum_{a,b}^{C^{N}_2}{E^{(k=2)}_{ab}} 
+ \sum_{a,b,c}^{C^{N}_3}{E^{(k=3)}_{abc}} + \cdots
\end{eqnarray}

\noindent For most cases, the equation above can be truncated at $k = 3$. Higher order 
terms contribute far less to the total energy while require much more computational
resources as $C^N_k$ roughly scales as $\mathcal{O}(N)$.

\subsection{One-body}

In kCON, the 1-body terms are expressed by a linear model:

\begin{eqnarray}
\sum_{a}^{C^N_1}{E^{(k=1)}_{a}} = \sum_{a}^{N}{E^{A_a}} = \sum_{A_{a}}{n^{A_a}E^{A_a}}
\end{eqnarray}

\noindent As an example, the 1-body contribution of a 
$\mathrm{C}_9 \mathrm{H}_7 \mathrm{N}$ is:

\begin{eqnarray}
E^{(k=1)} = 9E^{\mathrm{C}} + 7E^{\mathrm{H}} + E^{\mathrm{N}}
\end{eqnarray}

\noindent Here $E^{\mathrm{C}}$, $E^{\mathrm{H}}$ and $E^{\mathrm{N}}$ are all
trainable parameters.

\subsection{Two/three-body}

Independent convolutional neural networks are used to fit two/three-body terms:

\begin{eqnarray}
E^{(k=2)} & = & \sum_{a,b}^{C^N_2}{
	\boldmath{\mathrm{CNN}}^{\mathrm{A}_{a}\mathrm{A}_{b}}
}(r_{ab}) \\
E^{(k=3)} & = & \sum_{a,b,c}^{C^N_3}{
	\boldmath{\mathrm{CNN}}^{\mathrm{A}_{a}\mathrm{A}_{b}\mathrm{A}_{c}}
}(r_{ab}, r_{ac}, r_{bc})
\end{eqnarray}

\noindent To simplify the equations and normalize the distances $r$, an exponential 
transformation is adopted:

\begin{eqnarray}
z_{ab} 
= \exp{\left(-\frac{r_{ab}}{L_{a} + L_{b}}\right)}
= \exp{\left(-\frac{r_{ab}}{L_{ab}}\right)}
\end{eqnarray}

\noindent where $L_{a}$ is the covalent radius of element $A_{a}$. For non periodic 
molecules the P$\ddot{\mathrm{y}}\ddot{\mathrm{y}}$kko radii are used.

\subsection{The construction of the input feature matrix}

Now we can build the input feature matrix in a straightforward way. Taking the example 
of $\mathrm{C}_9 \mathrm{H}_7 \mathrm{N}$, the k-body terms and their dimensions are:

\begin{center}
	\scalebox{1.0}{
		\begin{tabular}{l*{3}{c}r}
			Term              & k & Expression & Dimension \\
			\hline
			CC    & 2 & $C^9_2$                         &  36 \\
			CH    & 2 & $C^9_1 \cdot C^7_1$             &  63 \\
			CN    & 2 & $C^9_1 \cdot C^1_1$             &   9 \\
			HH    & 2 & $C^7_2$                         &  21 \\
			HN    & 2 & $C^7_1 \cdot C^1_1$             &   7 \\
			CCC   & 3 & $C^9_3$                         &  84 \\
			CCH   & 3 & $C^9_2 \cdot C^7_1$             & 252 \\
			CCN   & 3 & $C^9_2 \cdot C^1_1$             &  36 \\
			CHH   & 3 & $C^9_1 \cdot C^7_2$             & 189 \\
			CHN   & 3 & $C^9_1 \cdot C^7_1 \cdot C^1_1$ &  63 \\
			HHH   & 3 & $C^7_3$                         &  35 \\
			HHN   & 3 & $C^7_2 \cdot C^1_1$             &  21 \\
			Total &   &                                 & 816 
		\end{tabular}	
	}
\end{center}

\noindent One can notice that $\mathrm{C}_9 \mathrm{H}_7 \mathrm{N}$ has 17 atoms but 
$816=C^{18}_3$. The CC and CCN, CH and CHN, HH and HHN all have the same dimension because $
\mathrm{C}_9 \mathrm{H}_7 \mathrm{N}$ only has one nitrogen atom. So here we propose a 'ghost 
atom' scheme which can simplify the construction of the input feature matrix. A ghost atom, 
denoted as X, is appended. Its distances to any real atom is $+\infty$. According to equation 
6, the scaled distance of X to any real atom will be zero. Then we drop all previous 2-body 
terms and only keep 3-body terms:

\begin{center}
	\scalebox{1.0}{
		\begin{tabular}{l*{3}{c}r}
			Term              & k & Expression & Dimension \\
			\hline
			CCX   & 3 & $C^9_2 \cdot C^1_1$             &  36 \\
			CHX   & 3 & $C^9_1 \cdot C^7_1 \cdot C^1_1$ &  63 \\
			CNX   & 3 & $C^9_1 \cdot C^1_1 \cdot C^1_1$ &   9 \\
			HHX   & 3 & $C^7_2 \cdot C^1_1$             &  21 \\
			HNX   & 3 & $C^7_1 \cdot C^1_1 \cdot C^1_1$ &   7 \\
			CCC   & 3 & $C^9_3$                         &  84 \\
			CCH   & 3 & $C^9_2 \cdot C^7_1$             & 252 \\
			CCN   & 3 & $C^9_2 \cdot C^1_1$             &  36 \\
			CHH   & 3 & $C^9_1 \cdot C^7_2$             & 189 \\
			CHN   & 3 & $C^9_1 \cdot C^7_1 \cdot C^1_1$ &  63 \\
			HHH   & 3 & $C^7_3$                         &  35 \\
			HHN   & 3 & $C^7_2 \cdot C^1_1$             &  21 \\
			Total &   &                                 & 816 
		\end{tabular}	
	}
\end{center}

\noindent Now we only have 3-body terms but the dimensions are unchanged. With this scheme, we 
can use just one matrix to store all 2-body and 3-body features.

\subsection{Permutational Invariance}

The three spatial (translational, rotational and permutational) invariances must all be 
satisfied. Since kCON only uses interatomic distances $r$, the translational and 
rotational invariances are naturally kept and the 1-body and 2-body terms are also 
permutationally invariant. However, the 3-body terms \(or higher\) do not satisfy this
requirement because the orders of the parameters of convolutional kernels are fixed 
while $(\mathrm{A}_{a}\mathrm{A}_{b}\mathrm{A}_{c})$ are inter-changeable. 

To overcome this problem, the conditional sorting scheme is adopted: the columns of the 
input matrix (the input layer) of each k-body CNN are ordered according to the bond types, 
and for each k-body interaction (matrix row) we only sort the  entries of the same atom 
types. Taking the examples of CHN, CCH and CCC:

\begin{itemize}
	\item CHN: each column represents a unique bond type (C-H, C-N, H-N). Sorting is not needed.
	\item CCN: the entries corresponding to C-C of each row should be sorted.
	\item CCC: all three entries of each row should be sorted.
\end{itemize}

\subsection{Loss}

By default, kCON uses the root mean squared error as the total loss to minimize:

\begin{eqnarray}
\mathrm{RMSE} = \sqrt{
	\frac{1}{n}
	\sum_{i=1}^{n}{ 
		\left( y_{i}^{\mathrm{kCON}} - y_{i}^{\mathrm{True}} \right)^2
	}
}	
\end{eqnarray}

\noindent kCON also supports exponentially-scaled RMSE if the contributions of the unstable 
structures should be minimized:

\begin{eqnarray}
\mathrm{esRMSE} = \sqrt{
	\frac{1}{n} 
	\sum_{i=1}^{n}{
		\exp{\left(-\frac{y_{i}^{\mathrm{kCON}} - y_{i}^{\mathrm{True}}}{k_BT} \right)}
		\left(y_{i}^{\mathrm{kCON}} - y_{i}^{\mathrm{True}} \right)^2
	}
}	
\end{eqnarray}

\section{Theoretical analysis of the forces}

Atomic force is the negative first-order derivative of energy with respect to 
displacement:

\begin{eqnarray}
f(r) = -\frac{\partial E(r)}{\partial r}
\end{eqnarray}

\noindent So it's straightforward to get kCON atomic forces:

\begin{eqnarray}
f(x_{i}) & = & -\frac{\partial{E^{total}}}{\partial{x_{i}}} \nonumber \\
& = & -\left(
	\frac{\partial{E^{(k=1)}}}{\partial{x_i}} 
	+ \frac{\partial{E^{(k=2)}}}{\partial{x_i}}
	+ \frac{\partial{E^{(k=3)}}}{\partial{x_i}} 
\right) \nonumber \\
& = & -\left(
\frac{
	\partial{\sum_{a,b}^{C^N_2}{
		\boldmath{\mathrm{CNN}}^{\mathrm{A}_{a}\mathrm{A}_{b}}}(z_{ab})}
	}{
		\partial{x_i}
	} 
+ 
\frac{
	\partial{\sum_{a,b,c}^{C^N_3}{
		\boldmath{\mathrm{CNN}}^{\mathrm{A}_{a}\mathrm{A}_{b}\mathrm{A}_{c}}}
		(z_{ab}, z_{ac}, z_{bc})}
	}{
		\partial{x_i}
	} 
\right) \nonumber \\
& = & -\left(
\sum_{a,b}^{C^N_2}{
	\frac{
		\partial{\boldmath{\mathrm{CNN}}^{\mathrm{A}_{a}\mathrm{A}_{b}}(z_{ab})}
	}{
		\partial{x_i}
	}
}
	+
\sum_{a,b,c}^{C^N_3}{
	\frac{
		\partial{\boldmath{\mathrm{CNN}}^{\mathrm{A}_{a}\mathrm{A}_{b}\mathrm{A}_{c}}
		(z_{ab}, z_{ac}, z_{bc})}
	}{
		\partial{x_i}
	}
}
\right)
\end{eqnarray}

\noindent where $f(x_{i})$ is the force component of atom $i$ along the X direction. We 
also have:

\begin{eqnarray}
%
% equation 11
%
\frac{
	\partial{\boldmath{\mathrm{CNN}}^{\mathrm{A}_{a}\mathrm{A}_{b}}(z_{ab})}
}{
	\partial{x_i}
} 
& = & 
\frac{\partial{
	\boldmath{\mathrm{CNN}}^{\mathrm{A}_{a}\mathrm{A}_{b}}(z_{ab})}
}{
	\partial{z_{ab}}
} \frac{\partial{z_{ab}}}{\partial{r_{ab}}} \frac{\partial{r_{ab}}}{\partial{x_i}} \\
%
% equation 12
%
\frac{ \partial{z_{ab}}}{\partial{r_{ab}}} 
& = & 
-\frac{z_{ab}}{L_{A_a} + L_{A_b}} = -\frac{z_{ab}}{L_{ab}} \\
%
% equation 13
%
\frac{\partial{r_{ab}}}{\partial{x_i}} & = & \begin{cases}
	\frac{x_a - x_b}{r_{ab}} & \quad \text{if } i = a \\
	-\frac{x_a - x_b}{r_{ab}} & \quad \text{if } i = b \\
	0                        & \quad \text{else}
\end{cases} 
\end{eqnarray}

\noindent Finally we get:

\begin{eqnarray}
r_{ab} & = & -L_{ab}\log{\left( z_{ab} \right)} \\
d^x_{ab} & = & x_{a} - x_{b} \\
d^y_{ab} & = & y_{a} - y_{b} \\
d^z_{ab} & = & z_{a} - z_{b} \\
\frac{\partial{z_{ab}}}{\partial{r_{ab}}} \frac{\partial{r_{ab}}}{\partial{\{x, y, z\}_i}} 
& = &
\begin{cases}
z_{ab} d^{\{x,y,z\}}_{ab} / (L_{ab}^{2} \log{(z_{ab})}) & \quad \text{if } i = a \\
-z_{ab} d^{\{x,y,z\}}_{ab} / (L_{ab}^{2} \log{(z_{ab})}) & \quad \text{if } i = b \\
0 & \quad \text{else}
\end{cases}
\end{eqnarray}

For three (or higher body) terms, the result is similar to Equation 11 (See the Appendix 
A for detailed derivation):

\begin{eqnarray}
\frac{
	\partial{\boldmath{\mathrm{CNN}}^{k}\left(\left\{ z \right\} \right)}
}{
	\partial{x_i}
} 
=  \sum_{ab}^{C^N_k}{
\frac{
	\partial{\boldmath{\mathrm{CNN}}^{k}\left(\left\{ z \right\} \right)}
}{
	\partial{z_{ab}}
} \frac{\partial{z_{ab}}}{\partial{r_{ab}}}\frac{\partial{r_{ab}}}{\partial{x_i}}}
\end{eqnarray}

As kCON is built upon Google's TensorFlow, the calculations of the gradients above become 
far more easier as TensorFlow can output the these complicated derivatives automatically:

\begin{eqnarray}
\frac{
	\partial{\boldmath{\mathrm{CNN}}^{k}\left(\left\{ z \right\} \right)}
}{
	\partial{z_{ab}}
}	
\end{eqnarray}

\section{Implementation of the forces}

The implementation the atomic forces is a complicated though the theoretical analysis is 
clear because we must make all operations \textbf{vectorizable} so that we can take
advantages of modern deep learning frameworks like TensorFlow or MXNet. 

\subsection{Dimension analysis}

Suppose we have a system composed of N atoms with $k^\mathrm{max}=3$, the total energy can be 
computed with the following equations:

\begin{eqnarray}
	E^{\mathrm{kCON}} & = & E^{(k=1)} + \mathrm{NN}(\boldsymbol{Z}) \\
	\boldsymbol{Z} & = & \left[
		\begin{array}{c}
			\vec{z_{1}}  \\
			\vec{z_{2}}  \\
			\vec{z_{3}}  \\
			\vec{z_{4}}  \\
			\vec{z_{5}}  \\
			\vdots \\
			\vec{z_{n}}  \\
		\end{array}
	\right]                                                         \\
	n & = & C^{N + 1}_3                                             \\
	\boldsymbol{L} & = & \left[
		\begin{array}{c}
			\vec{l_{1}}  \\
			\vec{l_{2}}  \\
			\vec{l_{3}}  \\
			\vec{l_{4}}  \\
			\vec{l_{5}}  \\
			\vdots \\
			\vec{l_{n}}  \\			
		\end{array}
	\right]
\end{eqnarray}

\noindent where \textbf{Z} is the input feature matrix with shape $[C^{N+1}_{3}, 3]$, 
$\vec{z_{i}}$ is a three-components vector representing the \textbf{conditionally sorted} 
features of a chemical pattern and \textbf{L} is the associated covalent radii matrix for 
\textbf{Z}. $E^{(k=1)}$ does not depend on interatomic distances, so we can safely ignore it 
when computing atomic forces. Now TensorFlow can output the derivatives of 
$E^{\mathrm{kCON}}$ with respect to the input feature matrix \textbf{Z} directly:

\begin{equation}
\frac{\partial{E^{\mathrm{kCON}}}}{\partial{\mathbf{Z}}} = 
\left[
	\begin{array}{c}
		\partial{E} / \partial{\vec{z_{1}}}  \\
		\partial{E} / \partial{\vec{z_{2}}}  \\
		\partial{E} / \partial{\vec{z_{3}}}  \\
		\partial{E} / \partial{\vec{z_{4}}}  \\
		\partial{E} / \partial{\vec{z_{5}}}  \\
		\vdots \\
		\partial{E} / \partial{\vec{z_{n}}}  \\
	\end{array}
\right]
\end{equation}

\noindent and the shape of $\partial{E^{\mathrm{kCON}}} / \partial{\boldsymbol{Z}}$ is
also $[C^{N+1}_{3}, 3]$. 

Now let's look into $\partial{E} / \partial{\vec{z_{i}}}$. Here we define 
$\vec{z_{1}} = [z_{12}, z_{13}, z_{23}]$ where $z_{ab}$ is the scaled interatomic distance of
atom $a$ and $b$. According to equation 15, $\partial{z_{12}} / \partial{x_{i}}$ will be non
-zero if and only if $i = a$ or $i = b$. Hence, 
$\partial{E} / \partial{z_{12}} \cdot \partial{z_{12}} / \partial{x_{i}}$ will only give 
effective contributions to \textbf{six} atomic force components: $f^x_1$, $f^y_1$, $f^z_1$, 
$f^x_2$, $f^y_2$ and $f^z_2$. Thus, $\partial{E^{\mathrm{kCON}}} / \partial{\boldsymbol{Z}}$ 
will produce $6 \cdot C^{N+1}_3 \cdot 3=18C^{N+1}_3$ atomic force contributions but only
$6 \cdot C^N_3 \cdot 3 + 6 \cdot C^N_2 \cdot 1$ of them are effective because the ghost atom 
should give zero contribution. Since we have N atoms, there will be 3N force components and 
each force component is the sum of $(N - 1)^2$ force contributions.

\subsection{Tiling}

According to the dimension analysis, each entry of \textbf{Z}, \textbf{L} and 
$\partial{E^{\mathrm{kCON}}} / \partial{Z}$ corresponds to six force components. So repeating 
these matrices 6 times will make each entry correspond to only one force component. This can
be achieved by  
\href{https://docs.scipy.org/doc/numpy/reference/generated/numpy.tile.html}{tiling}.
The following example demonstrates the tiled \textbf{Z}:

\begin{equation}
Z_{tiled} = \mathrm{tile}(Z, (1,6)) = \left[
\begin{array}{cccccc}
	\vec{z_{1}} & \vec{z_{1}} & \vec{z_{1}} & \vec{z_{1}} & \vec{z_{1}} & \vec{z_{1}}  \\
	\vec{z_{2}} & \vec{z_{2}} & \vec{z_{2}} & \vec{z_{2}} & \vec{z_{2}} & \vec{z_{2}}  \\
	\vec{z_{3}} & \vec{z_{3}} & \vec{z_{3}} & \vec{z_{3}} & \vec{z_{3}} & \vec{z_{3}}  \\
	\vec{z_{4}} & \vec{z_{4}} & \vec{z_{4}} & \vec{z_{4}} & \vec{z_{4}} & \vec{z_{4}}  \\
	\vec{z_{5}} & \vec{z_{5}} & \vec{z_{5}} & \vec{z_{5}} & \vec{z_{5}} & \vec{z_{5}}  \\
	\vdots      & \vdots      & \vdots      & \vdots      & \vdots      & \vdots       \\
	\vec{z_{n}} & \vec{z_{n}} & \vec{z_{n}} & \vec{z_{n}} & \vec{z_{n}} & \vec{z_{n}}  \\
		\end{array}
	\right]
\end{equation}

\noindent After the tiling, the shapes of $\boldsymbol{Z}_{tiled}$, $\boldsymbol{L}_{tiled}$ 
and $(\partial{E^{\mathrm{kCON}}} / \partial{Z})_{tiled}$ now become $[C^{N+1}_{3}, 18]$.

\subsection{Coordinates differences}

The one last auxiliary matrix to compute is the differences of the atomic coordinates 
$d^{\{x, y, z\}}_{ab}$ introduced in equation 18. The matrix, denoted as \textbf{D}, also has 
the shape of $[C^{N+1}_{3}, 18]$:

\begin{equation}
\mathbf{D} = \left[ 
\begin{array}{ccccccc}
\vec{d}_1 & \vec{d}_2 & \vec{d}_3 & \vec{d}_4 & \vec{d}_5 & \dots & \vec{d}_n 
\end{array}
\right]^T
\end{equation}

Suppose $\vec{z}_{1} = [z_{12}, z_{13}, z_{23}]$ and 
$\vec{l}_{1} = [l_{12}, l_{13}, l_{23}]$. After the tiling, we have:
\begin{eqnarray}
\left(\vec{z}_{1, tiled}\right)^T = \left[
	\begin{array}{c}
		z_{12} \\
		z_{13} \\
		z_{23} \\
		z_{12} \\
		z_{13} \\
		z_{23} \\
		z_{12} \\
		z_{13} \\
		z_{23} \\
		z_{12} \\
		z_{13} \\
		z_{23} \\
		z_{12} \\
		z_{13} \\
		z_{23} \\
		z_{12} \\
		z_{13} \\
		z_{23} \\
	\end{array}
\right]
, \quad
\left(\vec{l}_{1, tiled}\right)^T = \left[
	\begin{array}{c}
		l_{12} \\
		l_{13} \\
		l_{23} \\
		l_{12} \\
		l_{13} \\
		l_{23} \\
		l_{12} \\
		l_{13} \\
		l_{23} \\
		l_{12} \\
		l_{13} \\
		l_{23} \\
		l_{12} \\
		l_{13} \\
		l_{23} \\
		l_{12} \\
		l_{13} \\
		l_{23} \\
	\end{array}
\right]
\end{eqnarray}

\noindent So, we can easily compute the corresponding $d^{\{ x,y,z \}}_{ab}$:

\begin{equation}
\vec{d}_{1} = \begin{blockarray}{cc}
              & component \\
\begin{block}{(c)c}
	+d^x_{12} & f^x_1 \\
	+d^x_{13} & f^x_1 \\
	+d^x_{23} & f^x_2 \\
	+d^y_{12} & f^y_1 \\
	+d^y_{13} & f^y_1 \\
	+d^y_{23} & f^y_2 \\
	+d^z_{12} & f^z_1 \\
	+d^z_{13} & f^z_1 \\
	+d^z_{23} & f^z_2 \\
	-d^x_{12} & f^x_2 \\
	-d^x_{13} & f^x_3 \\
	-d^x_{23} & f^x_3 \\
	-d^y_{12} & f^y_2 \\
	-d^y_{13} & f^y_3 \\
	-d^y_{23} & f^y_3 \\
	-d^z_{12} & f^z_2 \\
	-d^z_{13} & f^z_3 \\
	-d^z_{23} & f^z_3 \\
\end{block}
\end{blockarray}
\end{equation}

\subsection{Atomic forces}

Finally we can compute atomic forces.


\section*{Appendix: a simple example}

Consider a simple example of $\mathrm{B}_{4}$, its input feature matrix should be:

\begin{equation}
\mathbf{Z}^{(0)} = \left[\begin{array}{ccc}
	z_{12} & 0        & 0        \\
	z_{13} & 0        & 0        \\
	z_{14} & 0        & 0        \\
	z_{23} & 0        & 0        \\
	z_{24} & 0        & 0        \\
	z_{34} & 0        & 0        \\
	z_{12} & z_{13} & z_{23} \\
	z_{12} & z_{14} & z_{24} \\
	z_{13} & z_{14} & z_{23} \\
	z_{23} & z_{24} & z_{34} \\
\end{array}
\right]
\end{equation}

\noindent where $z^(k)_{ab}$ represents the k-body normalized distance between atom $a$ and 
$b$. The first six rows of \textbf{Z} are 2-body features and the last four rows are 3-body
features. The latter analysis will only consider the 3-body part for simplicity.

Suppose the convolutional neural network for BBB has two hidden layers and one output layer.
The convolutional kernels are:

\begin{eqnarray}
\mathbf{W}^{(1)} & = & \left[\begin{array}{cccc}
	w^{(1)}_{11} & w^{(1)}_{12} & w^{(1)}_{13} & b^{(1)}_{1} \\
	w^{(1)}_{21} & w^{(1)}_{22} & w^{(1)}_{23} & b^{(1)}_{2} \\
\end{array}
\right] \\
\mathbf{W}^{(2)} & = & \left[\begin{array}{ccc}
	w^{(2)}_{11} & w^{(2)}_{12} & b^{(2)}_{1} \\
	w^{(2)}_{21} & w^{(2)}_{22} & b^{(2)}_{2} \\
\end{array}
\right] \\
\mathbf{W}^{(3)} & = & \left[\begin{array}{cc}
	w^{(3)}_{11} & w^{(3)}_{12} \\
\end{array}
\right]
\end{eqnarray}

\noindent where $\mathbf{W}^{(k)}$ is the kernel matrix for layer $k$. Each row of  
$\mathbf{W}^{(k)}$ represents a kernel and the last entry of each kernel is the bias unit. 
One should notice that the last layer (the output layer) does not have a bias unit.
The activation function used here is leaky ReLU:

\begin{eqnarray}
f(x) & = & \begin{cases}
	x & \quad \text{if } x \geq 0 \\
	\alpha x & \quad \text{else} \\
\end{cases} \\
\frac{\partial{f(x)}}{\partial{x}} & = & \begin{cases}
	1 & \quad \text{if } x \geq 0 \\
	\alpha & \quad \text{else} \\
\end{cases} \\
\alpha & = & 0.2
\end{eqnarray}

\noindent So the results of the first layer can be calculated:

\begin{eqnarray}
\mathbf{Z}^{(1)} 
& = & \left[\begin{array}{ccc}
	f(w^{(1)}_{11}z_{12} + w^{(1)}_{12}z_{13} + w^{(1)}_{13}z_{23} + b^{(1)}_1) &
	f(w^{(1)}_{21}z_{12} + w^{(1)}_{22}z_{13} + w^{(1)}_{23}z_{23} + b^{(1)}_2) \\
	f(w^{(1)}_{11}z_{12} + w^{(1)}_{12}z_{14} + w^{(1)}_{13}z_{24} + b^{(1)}_1) &
	f(w^{(1)}_{21}z_{12} + w^{(1)}_{22}z_{14} + w^{(1)}_{23}z_{24} + b^{(1)}_2) \\
	f(w^{(1)}_{11}z_{13} + w^{(1)}_{12}z_{14} + w^{(1)}_{13}z_{34} + b^{(1)}_1) &
	f(w^{(1)}_{21}z_{13} + w^{(1)}_{22}z_{14} + w^{(1)}_{23}z_{34} + b^{(1)}_2) \\
	f(w^{(1)}_{11}z_{23} + w^{(1)}_{12}z_{24} + w^{(1)}_{13}z_{34} + b^{(1)}_1) &
	f(w^{(1)}_{21}z_{23} + w^{(1)}_{22}z_{24} + w^{(1)}_{23}z_{34} + b^{(1)}_2) \\
\end{array}
\right] \nonumber \\
& = & \left[\begin{array}{ccc}	
	z^{(1)}_{11} & z^{(1)}_{12} \\
	z^{(1)}_{21} & z^{(1)}_{22} \\
	z^{(1)}_{31} & z^{(1)}_{32} \\
	z^{(1)}_{41} & z^{(1)}_{42} \\
\end{array}
\right]
\end{eqnarray}

\noindent Then we can obtain the results of the second layer:

\begin{eqnarray}
\mathbf{Z}^{(2)} 
& = & \left[\begin{array}{ccc}
	f(w^{(2)}_{11}z^{(1)}_{11} + w^{(2)}_{12}z^{(1)}_{12} + b^{(2)}_1) &
	f(w^{(2)}_{21}z^{(1)}_{11} + w^{(2)}_{22}z^{(1)}_{12} + b^{(2)}_2) \\
	f(w^{(2)}_{11}z^{(1)}_{21} + w^{(2)}_{12}z^{(1)}_{22} + b^{(2)}_1) &
	f(w^{(2)}_{21}z^{(1)}_{21} + w^{(2)}_{22}z^{(1)}_{22} + b^{(2)}_2) \\
	f(w^{(2)}_{11}z^{(1)}_{31} + w^{(2)}_{12}z^{(1)}_{32} + b^{(2)}_1) &
	f(w^{(2)}_{21}z^{(1)}_{31} + w^{(2)}_{22}z^{(1)}_{32} + b^{(2)}_2) \\
	f(w^{(2)}_{11}z^{(1)}_{41} + w^{(2)}_{12}z^{(1)}_{42} + b^{(2)}_1) &
	f(w^{(2)}_{21}z^{(1)}_{41} + w^{(2)}_{22}z^{(1)}_{42} + b^{(2)}_2) \\
\end{array}
\right] \nonumber \\
& = & \left[\begin{array}{ccc}	
	z^{(2)}_{11} & z^{(2)}_{12} \\
	z^{(2)}_{21} & z^{(2)}_{22} \\
	z^{(2)}_{31} & z^{(2)}_{32} \\
	z^{(2)}_{41} & z^{(2)}_{42} \\
\end{array}
\right]
\end{eqnarray}

\noindent The results of output layer should be:

\begin{equation}
\mathbf{Z}^{(3)} = \left[\begin{array}{c}
	z^{(2)}_{11}w^{(3)}_{11} + z^{(2)}_{12}w^{(3)}_{12} \\
	z^{(2)}_{21}w^{(3)}_{11} + z^{(2)}_{22}w^{(3)}_{12} \\
	z^{(2)}_{31}w^{(3)}_{11} + z^{(2)}_{32}w^{(3)}_{12} \\
	z^{(2)}_{41}w^{(3)}_{11} + z^{(2)}_{42}w^{(3)}_{12} \\
\end{array}
\right]
\end{equation}

\noindent Finally we can get the total energy $E$ which is the sum of the k-body energies of 
the output layer:

\begin{eqnarray}
E 
& = & 
z^{(2)}_{11}w^{(3)}_{11} + z^{(2)}_{12}w^{(3)}_{12} + 
z^{(2)}_{21}w^{(3)}_{11} + z^{(2)}_{22}w^{(3)}_{12} + 
z^{(2)}_{31}w^{(3)}_{11} + z^{(2)}_{32}w^{(3)}_{12} + 
z^{(2)}_{41}w^{(3)}_{11} + z^{(2)}_{42}w^{(3)}_{12} \nonumber \\
& = &
\left(\begin{array}{cccccccc}
	1 & 1 & 1 & 1 & 1 & 1 & 1 & 1 \\
\end{array}
\right)^T
\left[\begin{array}{c}
	z^{(2)}_{11}w^{(3)}_{11} \\
	z^{(2)}_{12}w^{(3)}_{12} \\
	z^{(2)}_{21}w^{(3)}_{11} \\
	z^{(2)}_{22}w^{(3)}_{12} \\
	z^{(2)}_{31}w^{(3)}_{11} \\
	z^{(2)}_{32}w^{(3)}_{12} \\
	z^{(2)}_{41}w^{(3)}_{11} \\
	z^{(2)}_{42}w^{(3)}_{12} \\
\end{array}
\right] \nonumber \\
& = &
\mathbf{I}^T
\left[\begin{array}{c}
	f(w^{(2)}_{11}z^1_{11} + w^{(2)}_{12}z^1_{12} + b^{(2)}_1)w^3_{11} \\
	f(w^{(2)}_{21}z^1_{11} + w^{(2)}_{22}z^1_{12} + b^{(2)}_2)w^3_{12} \\
	f(w^{(2)}_{11}z^1_{21} + w^{(2)}_{12}z^1_{22} + b^{(2)}_1)w^3_{11} \\ 
	f(w^{(2)}_{21}z^1_{21} + w^{(2)}_{22}z^1_{22} + b^{(2)}_2)w^3_{12} \\
	f(w^{(2)}_{11}z^1_{31} + w^{(2)}_{12}z^1_{32} + b^{(2)}_1)w^3_{11} \\
	f(w^{(2)}_{21}z^1_{31} + w^{(2)}_{22}z^1_{32} + b^{(2)}_2)w^3_{12} \\
	f(w^{(2)}_{11}z^1_{41} + w^{(2)}_{12}z^1_{42} + b^{(2)}_1)w^3_{11} \\
	f(w^{(2)}_{21}z^1_{41} + w^{(2)}_{22}z^1_{42} + b^{(2)}_2)w^3_{12}
\end{array}
\right] = \mathbf{I}^T \mathbf{Y}
\end{eqnarray}

\noindent where \textbf{Y} is:

\begin{equation}
\mathbf{Y} = 
\left[\begin{array}{c}
	f\left(
		w^{(2)}_{11}
			f(w^{(1)}_{11}z_{12} + w^{(1)}_{12}z_{13} + w^{(1)}_{13}z_{23} + b^{(1)}_1) + 
		w^{(2)}_{12}
			f(w^{(1)}_{21}z_{12} + w^{(1)}_{22}z_{13} + w^{(1)}_{23}z_{23} + b^{(1)}_2) + 
		b^{(2)}_1
	\right)w^{(3)}_{11} \\
	f\left(
		w^{(2)}_{21}
			f(w^{(1)}_{11}z_{12} + w^{(1)}_{12}z_{13} + w^{(1)}_{13}z_{23} + b^{(1)}_1) + 
		w^{(2)}_{22}
			f(w^{(1)}_{21}z_{12} + w^{(1)}_{22}z_{13} + w^{(1)}_{23}z_{23} + b^{(1)}_2) + 
		b^{(2)}_2
	\right)w^{(3)}_{12} \\
	f\left(
		w^{(2)}_{11}
			f(w^{(1)}_{11}z_{12} + w^{(1)}_{12}z_{14} + w^{(1)}_{13}z_{24} + b^{(1)}_1) + 
		w^{(2)}_{12}
			f(w^{(1)}_{21}z_{12} + w^{(1)}_{22}z_{14} + w^{(1)}_{23}z_{24} + b^{(1)}_2) + 
		b^{(2)}_1
	\right)w^{(3)}_{11} \\ 
	f\left(
		w^{(2)}_{21}
			f(w^{(1)}_{11}z_{12} + w^{(1)}_{12}z_{14} + w^{(1)}_{13}z_{24} + b^{(1)}_1) + 
		w^{(2)}_{22}
			f(w^{(1)}_{21}z_{12} + w^{(1)}_{22}z_{14} + w^{(1)}_{23}z_{24} + b^{(1)}_2) + 
		b^{(2)}_2
	\right)w^{(3)}_{12} \\
	f\left(
		w^{(2)}_{11}
			f(w^{(1)}_{11}z_{13} + w^{(1)}_{12}z_{14} + w^{(1)}_{13}z_{34} + b^{(1)}_1) + 
		w^{(2)}_{12}
			f(w^{(1)}_{21}z_{13} + w^{(1)}_{22}z_{14} + w^{(1)}_{23}z_{34} + b^{(1)}_2) + 
		b^{(2)}_1
	\right)w^{(3)}_{11} \\
	f\left(
		w^{(2)}_{21}
			f(w^{(1)}_{11}z_{13} + w^{(1)}_{12}z_{14} + w^{(1)}_{13}z_{34} + b^{(1)}_1) +
		w^{(2)}_{22}
			f(w^{(1)}_{21}z_{13} + w^{(1)}_{22}z_{14} + w^{(1)}_{23}z_{34} + b^{(1)}_2) + 
		b^{(2)}_2
	\right)w^{(3)}_{12} \\
	f\left(
		w^{(2)}_{11}
			f(w^{(1)}_{11}z_{23} + w^{(1)}_{12}z_{24} + w^{(1)}_{13}z_{34} + b^{(1)}_1) +
		w^{(2)}_{12}
			f(w^{(1)}_{21}z_{23} + w^{(1)}_{22}z_{24} + w^{(1)}_{23}z_{34} + b^{(1)}_2) + 
		b^{(2)}_1
	\right)w^{(3)}_{11} \\
	f\left(
		w^{(2)}_{21}
			f(w^{(1)}_{11}z_{23} + w^{(1)}_{12}z_{24} + w^{(1)}_{13}z_{34} + b^{(1)}_1) + 
		w^{(2)}_{22}
			f(w^{(1)}_{21}z_{23} + w^{(1)}_{22}z_{24} + w^{(1)}_{23}z_{34} + b^{(1)}_2) + 
		b^{(2)}_2
	\right)w^{(3)}_{12}
\end{array}
\right]
\end{equation}

Hence, the derivative of $E$ with respect to $z_{ab}$ can be easily calculated:

\begin{eqnarray}
\frac{\partial{E}}{\partial{z_{12}}} 
& = &
w^{(3)}_{11}\frac{\partial{f(z_{11}^{(3)}})}{\partial{z_{11}^{(2)}}} \left(
	w_{11}^{(2)}\frac{\partial{f(z_{11}^{(1))}}}{\partial{z_{11}^{(1)}}}w^{(1)}_{11} +
	w_{12}^{(2)}\frac{\partial{f(z_{12}^{(1))}}}{\partial{z_{12}^{(1)}}}w^{(1)}_{21}  
\right) + \nonumber \\
&& w^{(3)}_{12}\frac{\partial{f(z_{12}^{(3)}})}{\partial{z_{12}^{(2)}}} \left(
	w_{21}^{(2)}\frac{\partial{f(z_{11}^{(1))}}}{\partial{z_{11}^{(1)}}}w^{(1)}_{11} +
	w_{22}^{(2)}\frac{\partial{f(z_{12}^{(1))}}}{\partial{z_{12}^{(1)}}}w^{(1)}_{21}  
\right) + \nonumber \\
&& w^{(3)}_{11}\frac{\partial{f(z_{21}^{(3)}})}{\partial{z_{21}^{(2)}}} \left(
	w_{11}^{(2)}\frac{\partial{f(z_{21}^{(1))}}}{\partial{z_{21}^{(1)}}}w^{(1)}_{11} +
	w_{12}^{(2)}\frac{\partial{f(z_{22}^{(1))}}}{\partial{z_{22}^{(1)}}}w^{(1)}_{21}  
\right) + \nonumber \\
&& w^{(3)}_{12}\frac{\partial{f(z_{22}^{(3)}})}{\partial{z_{22}^{(2)}}} \left(
	w_{21}^{(2)}\frac{\partial{f(z_{21}^{(1))}}}{\partial{z_{21}^{(1)}}}w^{(1)}_{11} +
	w_{22}^{(2)}\frac{\partial{f(z_{22}^{(1))}}}{\partial{z_{22}^{(1)}}}w^{(1)}_{21}  
\right)
\end{eqnarray} 

\noindent Since $z_{12} = e^{-r_{12} / L_{12}}$ and 
$r_{12} = \sqrt{(x_1 - x_2)^2 + (y_1 - y_2)^2 + (z_1 - z_2)^2}$, the derivative of $y$ 
with respect to $x_1$ can be calculated:

\begin{equation}
\frac{\partial{E}}{\partial{x_1}} = 
\frac{\partial{E}}{\partial{z_{12}}}\frac{\partial{z_{12}}}{\partial{x_{1}}} +
\frac{\partial{E}}{\partial{z_{13}}}\frac{\partial{z_{13}}}{\partial{x_{1}}} +
\frac{\partial{E}}{\partial{z_{14}}}\frac{\partial{z_{14}}}{\partial{x_{1}}}
\end{equation}

\noindent The equation above can be written in matrix form:

\begin{eqnarray}
\frac{\partial{E}}{\partial{x_1}} = \left[\begin{array}{ccc}
	\partial{E} / \partial{z_{12}} &
	\partial{E} / \partial{z_{13}} &
	\partial{E} / \partial{z_{14}} \\
\end{array}
\right]^T
\left[\begin{array}{c}
	\partial{z_{12}} / \partial{x_{1}} \\
	\partial{z_{13}} / \partial{x_{1}} \\
	\partial{z_{14}} / \partial{x_{1}} \\
\end{array}
\right]
\end{eqnarray}

\noindent Similarly, we can construct the matrix forms of the derivatives of E with respect to 
all force components:

\begin{eqnarray}
\frac{\partial{E}}{\partial{y_1}} = \left[\begin{array}{ccc}
	\partial{E} / \partial{z_{12}} &
	\partial{E} / \partial{z_{13}} &
	\partial{E} / \partial{z_{14}} \\
\end{array}
\right]^T
\left[\begin{array}{c}
	\partial{z_{12}} / \partial{y_{1}} \\
	\partial{z_{13}} / \partial{y_{1}} \\
	\partial{z_{14}} / \partial{y_{1}} \\
\end{array}
\right] \\ % y1
\frac{\partial{E}}{\partial{z_1}} = \left[\begin{array}{ccc}
	\partial{E} / \partial{z_{12}} &
	\partial{E} / \partial{z_{13}} &
	\partial{E} / \partial{z_{14}} \\
\end{array}
\right]^T
\left[\begin{array}{c}
	\partial{z_{12}} / \partial{z_{1}} \\
	\partial{z_{13}} / \partial{z_{1}} \\
	\partial{z_{14}} / \partial{z_{1}} \\
\end{array}
\right] \\ % z1
\frac{\partial{E}}{\partial{x_2}} = \left[\begin{array}{ccc}
	\partial{E} / \partial{z_{12}} &
	\partial{E} / \partial{z_{23}} &
	\partial{E} / \partial{z_{24}} \\
\end{array}
\right]^T
\left[\begin{array}{c}
	\partial{z_{12}} / \partial{x_{2}} \\
	\partial{z_{23}} / \partial{x_{2}} \\
	\partial{z_{24}} / \partial{x_{2}} \\
\end{array}
\right] \\ % x2
\frac{\partial{E}}{\partial{y_2}} = \left[\begin{array}{ccc}
	\partial{E} / \partial{z_{12}} &
	\partial{E} / \partial{z_{23}} &
	\partial{E} / \partial{z_{24}} \\
\end{array}
\right]^T
\left[\begin{array}{c}
	\partial{z_{12}} / \partial{y_{2}} \\
	\partial{z_{23}} / \partial{y_{2}} \\
	\partial{z_{24}} / \partial{y_{2}} \\
\end{array}
\right] \\ % y2
\frac{\partial{E}}{\partial{z_2}} = \left[\begin{array}{ccc}
	\partial{E} / \partial{z_{12}} &
	\partial{E} / \partial{z_{23}} &
	\partial{E} / \partial{z_{24}} \\
\end{array}
\right]^T
\left[\begin{array}{c}
	\partial{z_{12}} / \partial{z_{2}} \\
	\partial{z_{23}} / \partial{z_{2}} \\
	\partial{z_{24}} / \partial{z_{2}} \\
\end{array}
\right] \\ % z2
\frac{\partial{E}}{\partial{x_3}} = \left[\begin{array}{ccc}
	\partial{E} / \partial{z_{13}} &
	\partial{E} / \partial{z_{23}} &
	\partial{E} / \partial{z_{34}} \\
\end{array}
\right]^T
\left[\begin{array}{c}
	\partial{z_{13}} / \partial{x_{3}} \\
	\partial{z_{23}} / \partial{x_{3}} \\
	\partial{z_{34}} / \partial{x_{3}} \\
\end{array}
\right] \\ % x3
\frac{\partial{E}}{\partial{y_2}} = \left[\begin{array}{ccc}
	\partial{E} / \partial{z_{13}} &
	\partial{E} / \partial{z_{23}} &
	\partial{E} / \partial{z_{34}} \\
\end{array}
\right]^T
\left[\begin{array}{c}
	\partial{z_{13}} / \partial{y_{3}} \\
	\partial{z_{23}} / \partial{y_{3}} \\
	\partial{z_{34}} / \partial{y_{3}} \\
\end{array}
\right] \\ % y3
\frac{\partial{E}}{\partial{z_3}} = \left[\begin{array}{ccc}
	\partial{E} / \partial{z_{13}} &
	\partial{E} / \partial{z_{23}} &
	\partial{E} / \partial{z_{34}} \\
\end{array}
\right]^T
\left[\begin{array}{c}
	\partial{z_{13}} / \partial{z_{3}} \\
	\partial{z_{23}} / \partial{z_{3}} \\
	\partial{z_{34}} / \partial{z_{3}} \\
\end{array}
\right] \\ % z3
\frac{\partial{E}}{\partial{x_4}} = \left[\begin{array}{ccc}
	\partial{E} / \partial{z_{14}} &
	\partial{E} / \partial{z_{24}} &
	\partial{E} / \partial{z_{34}} \\
\end{array}
\right]^T
\left[\begin{array}{c}
	\partial{z_{14}} / \partial{x_{4}} \\
	\partial{z_{24}} / \partial{x_{4}} \\
	\partial{z_{34}} / \partial{x_{4}} \\
\end{array}
\right] \\ % x4
\frac{\partial{E}}{\partial{y_4}} = \left[\begin{array}{ccc}
	\partial{E} / \partial{z_{14}} &
	\partial{E} / \partial{z_{24}} &
	\partial{E} / \partial{z_{34}} \\
\end{array}
\right]^T
\left[\begin{array}{c}
	\partial{z_{14}} / \partial{y_{4}} \\
	\partial{z_{24}} / \partial{y_{4}} \\
	\partial{z_{34}} / \partial{y_{4}} \\
\end{array}
\right] \\ % y4
\frac{\partial{E}}{\partial{z_4}} = \left[\begin{array}{ccc}
	\partial{E} / \partial{z_{14}} &
	\partial{E} / \partial{z_{24}} &
	\partial{E} / \partial{z_{34}} \\
\end{array}
\right]^T
\left[\begin{array}{c}
	\partial{z_{14}} / \partial{z_{4}} \\
	\partial{z_{24}} / \partial{z_{4}} \\
	\partial{z_{34}} / \partial{z_{4}} \\
\end{array}
\right]
\end{eqnarray}


\end{document}
